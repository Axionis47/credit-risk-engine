name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  REGISTRY_URL: us-central1-docker.pkg.dev

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: pgvector/pgvector:pg15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pp_final_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libffi-dev libssl-dev python3-dev

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          apps/editor-frontend/package-lock.json
          apps/ideahunter-frontend/package-lock.json
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install pytest pytest-asyncio pytest-mock httpx
        # Install dependencies for each service
        for service in services/*/; do
          if [ -f "$service/requirements.txt" ]; then
            echo "Installing dependencies for $service"
            pip install -r "$service/requirements.txt"
          fi
        done
        # Install gateway API dependencies
        echo "Installing gateway API dependencies"
        pip install -r apps/gateway-api/requirements.txt
    
    - name: Install Frontend dependencies
      run: |
        cd apps/editor-frontend && npm ci
        cd ../ideahunter-frontend && npm ci
    
    - name: Run Python tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/pp_final_test
        REDIS_URL: redis://localhost:6379
        OPENAI_API_KEY: test-key
        ANTHROPIC_API_KEY: test-key
        JWT_SECRET: test-secret
        GOOGLE_CLIENT_ID: test-client-id
        GOOGLE_CLIENT_SECRET: test-client-secret
        REDDIT_CLIENT_ID: test-reddit-id
        REDDIT_CLIENT_SECRET: test-reddit-secret
      run: |
        # Run tests for each service that has them
        for service in services/*/; do
          if [ -f "$service/pytest.ini" ] || [ -d "$service/tests" ]; then
            echo "Running tests for $service"
            cd "$service" && python -m pytest -v || true
            cd - > /dev/null
          fi
        done
    
    - name: Run Frontend tests
      run: |
        cd apps/editor-frontend && npm test
        cd ../ideahunter-frontend && npm test
    
    - name: Lint Python code
      run: |
        pip install flake8
        flake8 services/ apps/gateway-api/ --count --select=E9,F63,F7,F82 --show-source --statistics
    
    - name: Lint Frontend code
      run: |
        cd apps/editor-frontend && npm run lint
        cd ../ideahunter-frontend && npm run lint

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGISTRY_URL }}
    
    - name: Build and push images
      run: |
        # Build and push backend services
        services=(
          "ingest-svc:services/ingest-svc"
          "embed-svc:services/embed-svc"
          "retrieval-svc:services/retrieval-svc"
          "editor-svc:services/editor-svc"
          "reddit-sync-svc:services/reddit-sync-svc"
          "gateway-api:apps/gateway-api"
        )
        
        for service_info in "${services[@]}"; do
          IFS=':' read -r service_name service_path <<< "$service_info"
          
          echo "Building ${service_name}..."
          docker build -t ${{ env.REGISTRY_URL }}/${{ env.GCP_PROJECT_ID }}/pp-final/${service_name}:${{ github.sha }} \
            -t ${{ env.REGISTRY_URL }}/${{ env.GCP_PROJECT_ID }}/pp-final/${service_name}:latest \
            -f infra/docker/Dockerfile.python \
            ${service_path}
          
          echo "Pushing ${service_name}..."
          docker push ${{ env.REGISTRY_URL }}/${{ env.GCP_PROJECT_ID }}/pp-final/${service_name}:${{ github.sha }}
          docker push ${{ env.REGISTRY_URL }}/${{ env.GCP_PROJECT_ID }}/pp-final/${service_name}:latest
        done
        
        # Build and push frontend services
        frontends=(
          "editor-frontend:apps/editor-frontend"
          "ideahunter-frontend:apps/ideahunter-frontend"
        )
        
        for frontend_info in "${frontends[@]}"; do
          IFS=':' read -r frontend_name frontend_path <<< "$frontend_info"
          
          echo "Building ${frontend_name}..."
          docker build -t ${{ env.REGISTRY_URL }}/${{ env.GCP_PROJECT_ID }}/pp-final/${frontend_name}:${{ github.sha }} \
            -t ${{ env.REGISTRY_URL }}/${{ env.GCP_PROJECT_ID }}/pp-final/${frontend_name}:latest \
            -f infra/docker/Dockerfile.nextjs \
            ${frontend_path}
          
          echo "Pushing ${frontend_name}..."
          docker push ${{ env.REGISTRY_URL }}/${{ env.GCP_PROJECT_ID }}/pp-final/${frontend_name}:${{ github.sha }}
          docker push ${{ env.REGISTRY_URL }}/${{ env.GCP_PROJECT_ID }}/pp-final/${frontend_name}:latest
        done
    
    - name: Deploy to Cloud Run
      run: |
        # Deploy services with latest images
        services=(
          "gateway-api"
          "ingest-svc"
          "embed-svc"
          "retrieval-svc"
          "editor-svc"
          "reddit-sync-svc"
          "editor-frontend"
          "ideahunter-frontend"
        )
        
        for service in "${services[@]}"; do
          echo "Deploying ${service}..."
          gcloud run services update ${service} \
            --image=${{ env.REGISTRY_URL }}/${{ env.GCP_PROJECT_ID }}/pp-final/${service}:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --quiet || echo "Service ${service} might not exist yet, will be created by Terraform"
        done
    
    - name: Run database migrations
      run: |
        # Create a temporary Cloud Run job for migrations
        gcloud run jobs create migrate-db-${{ github.sha }} \
          --image=${{ env.REGISTRY_URL }}/${{ env.GCP_PROJECT_ID }}/pp-final/ingest-svc:${{ github.sha }} \
          --region=${{ env.GCP_REGION }} \
          --project=${{ env.GCP_PROJECT_ID }} \
          --set-env-vars="DATABASE_URL=postgresql://pp_final:$(gcloud secrets versions access latest --secret=database-password --project=${{ env.GCP_PROJECT_ID }})@$(gcloud sql instances describe pp-final-postgres --project=${{ env.GCP_PROJECT_ID }} --format='value(ipAddresses[0].ipAddress)'):5432/pp_final" \
          --vpc-connector=pp-final-connector \
          --vpc-egress=private-ranges-only \
          --service-account=pp-final-cloud-run@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
          --command=alembic \
          --args=upgrade,head \
          --max-retries=3 \
          --parallelism=1 \
          --task-count=1 \
          --cpu=1 \
          --memory=512Mi \
          --task-timeout=600 \
          || echo "Migration job might already exist"
        
        # Execute the migration
        gcloud run jobs execute migrate-db-${{ github.sha }} \
          --region=${{ env.GCP_REGION }} \
          --project=${{ env.GCP_PROJECT_ID }} \
          --wait
        
        # Clean up the job
        gcloud run jobs delete migrate-db-${{ github.sha }} \
          --region=${{ env.GCP_REGION }} \
          --project=${{ env.GCP_PROJECT_ID }} \
          --quiet
